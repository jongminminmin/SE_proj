<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>채팅</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #chatArea {
      height: 400px;
      overflow-y: scroll;
      border: 1px solid gray;
      padding: 10px;
      margin-bottom: 10px;
    }
    #receiverList {
      overflow-x: auto;
      white-space: nowrap;
      border-top: 1px solid #ccc;
      padding-top: 5px;
      margin-top: 10px;
    }
    #receiverList button {
      margin-right: 10px;
      padding: 5px 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>채팅</h2>

<!-- 채팅 메시지 출력 영역 -->
<div id="chatArea"></div>

<!-- 메시지 입력 영역 -->
<input type="text" id="messageInput" placeholder="메시지 입력" style="width: 70%;">
<button id="sendBtn">전송</button>

<!-- 수신자 선택 영역 -->
<div>
  <strong>받는 사람 선택:</strong>
  <div id="receiverList"></div>
</div>

<script>
  let stompClient = null;
  let selectedReceiverId = null;
  let currentUserId = null;

  function connect() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
      console.log('Connected: ' + frame);

      // 현재 로그인된 사용자 정보 가져오기
      fetch('/api/user/me')
              .then(res => res.json())
              .then(user => {
                currentUserId = user.id;

                // 수신자별 구독
                stompClient.subscribe('/topic/private/' + currentUserId, function (messageOutput) {
                  const message = JSON.parse(messageOutput.body);
                  showMessage(message.username + ': ' + message.content);
                });

                loadReceiverList(); // 사용자 목록 불러오기
              });
    });
  }

  // 수신자 목록 표시
  function loadReceiverList() {
    fetch('/api/user/list')
            .then(res => res.json())
            .then(users => {
              const receiverList = document.getElementById("receiverList");
              receiverList.innerHTML = "";

              users.forEach(user => {
                if (user.id !== currentUserId) {
                  const btn = document.createElement("button");
                  btn.textContent = user.username;
                  btn.onclick = function () {
                    selectedReceiverId = user.id;
                    alert(user.username + "님에게 메시지를 보냅니다.");
                  };
                  receiverList.appendChild(btn);
                }
              });
            });
  }

  // 메시지 전송
  document.getElementById('sendBtn').addEventListener('click', function () {
    const content = document.getElementById('messageInput').value;
    if (!selectedReceiverId) {
      alert("수신자를 먼저 선택하세요.");
      return;
    }

    stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
      receiverId: selectedReceiverId,
      roomId: 1,
      content: content
    }));

    document.getElementById('messageInput').value = '';
  });

  // 채팅 메시지 출력
  function showMessage(message) {
    const chatArea = document.getElementById("chatArea");
    const msg = document.createElement("div");
    msg.textContent = message;
    chatArea.appendChild(msg);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  connect();
</script>

</body>
</html>